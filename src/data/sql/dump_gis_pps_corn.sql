-- JOIN QueryStruc.dbo.QT_GroupDetail d on m.YearUID = d.YearUID

/*
  Use for mass dump of GIS pps rows in a form that ml scripts can transform and encode.
 */

SELECT TOP 100
  ym.Year,
  h.YearID,
  h.YearUID,
  h.FieldUID,
  ShapeXml.value('(//Xmin)[1]', 'float') AS Lon,
  ShapeXml.value('(//Ymin)[1]', 'float') AS Lat,
  pps.UID,
  Crop,
  Company,
  Variety,
  PlntDate,
  Replant,
  TargPop,
  K2ApMthd,
  Row_Spc,
  SeedTreat,
  PrevCrop,
  Till_Type,
  Chmresis,
  Disresis,
  Pstresis,
  RM,
  Spectrt,
  PriNApMthd,
  PriNTime,
  PriNRate,
  PriNType,
  PriNAdd,
  Sc1NApMthd,
  Sc1NTime,
  Sc1NRate,
  Sc1NType,
  Sc2NApMthd,
  Sc2NTime,
  Sc2NRate,
  Sc2NType,
  PApMthd,
  PTime,
  PRate,
  PType,
  KApMthd,
  KTime,
  KRate,
  KType,
  StrNRate,
  StrPRate,
  StrKRate,
  StrType,
  ManNRate,
  ManPRate,
  ManKRate,
  ManureType,
  LimeYear,
  LimeECCE,
  LimeRate,
  PreMethod,
  PreAppDate,
  Pre1Name,
  Pre1Rate,
  Pre2Name,
  Pre2Rate,
  Pre3Name,
  Pre3Rate,
  PreAdd1,
  Foliar1,
  Foliar2,
  PostMethod,
  Pst1ApDate,
  Pst1Name,
  Pst1Rate,
  Pst2Name,
  Pst2Rate,
  Pst3Name,
  Pst3Rate,
  Pst4Name,
  Pst4Rate,
  PstAdd1,
  PstAdd2,
  P2Type,
  P2Rate,
  PstMethod2,
  Pst2ApDate,
  Pst5Name,
  Pst5Rate,
  Pst6Name,
  Pst6Rate,
  Pst7Name,
  Pst7Rate,
  Pst8Name,
  Pst8Rate,
  P2Time,
  PN1Rate,
  Foliar1Time,
  PN2Rate,
  Foliar2Time,
  Isc1ApDate,
  Isc1Name,
  Isc1Rate,
  Isc2ApDate,
  Isc2Name,
  Isc2Rate,
  DownMargin,
  Singulate,
  ProperSpce,
  PH,
  PHBUFFER,
  PHOSPHORUS,
  POTASSIUM,
  OM,
  CEC,
  CALCIUM,
  MAGNESIUM,
  SULFUR,
  ZINC,
  MANGANESE,
  BORON,
  KBaseSat,
  MgBaseSat,
  CaBaseSat,
  HBaseSat,
  GrContact,
  TotNRate,
  TotPRate,
  TotKRate,
  Area,
  CSR,
  DEEP,
  IrrgType,
  Irrigated,
  Plnt_Spd,
  PlntDate#,
  SHALLOW,
  SLOPE_RANG,
  SMS,
  SOILNAME,
  TEXTURE,
  Dry_Yield,
  HarvDate,
  HarvDate#,
  Harv_Plnt,
  HarvSpeed,
  Moisture,
  NUsage,
  SoilGrtGroup,
  SoilSubOrder,
  SoilOrder,
  Fungicide1,
  Fungicide2,
  Fung1Rate,
  Fung2Rate,
  Fung1ApDate,
  Fung2ApDate,
  SulfProd,
  SulfTime,
  SulfApMthd,
  MicroName,
  MicroApMthd,
  MicroTime,
  CheckTest,
  MgmtZone,
  SulfRate,
  BoronRate,
  ZincRate,
  MnRate,
  ASNT,
  SulfNRate,
  PRem,
  KRem,
  PRem2Yrs,
  KRem2Yrs,
  Elevation,
  NDVI,
  DeepP,
  DeepK,
  Sc3NApMthd,
  Sc3NRate,
  Sc3NTime,
  Sc3NType,
  RY,
  DownForce,
  SampleDate,
  Ndex,
  SdUsage,
  K2Rate,
  TotSulfRate,
  SulfN2Rate,
  Sulf2Rate,
  ManSRate,
  RYCY,
  Foliar3,
  Foliar3Time,
  K2Time,
  K2Type,
  Sulf2ApMthd,
  Sulf2Prod,
  Sulf2Time,
  Fung1ApMthd,
  Fung2ApMthd,
  P2ApMthd,
  YrsInCrop,
  IrrigAmount,
  CvrCrop,
  Fungicide3,
  Fung3ApDate,
  Fung3ApMthd,
  Fung3Rate,
  Isc3ApDate,
  Isc3Name,
  Isc3Rate,
  Sc1NAdd,
  Sc2NAdd,
  Sc3NAdd,
  ManAdd,
  NO3,
  CSR2,
  StrSRate,
  StrZnRate,
  CaMgRatio,
  Pre6Name,
  Pre6Rate,
  Pre7Name,
  Pre7Rate,
  Pre8Name,
  Pre8Rate,
  PreAdd6,
  Pre6AppDate,
  Pre6Method,
  Pst30ApDate,
  Pst30Name,
  Pst30Rate,
  PstAdd30,
  PstMethod30,
  Pst31Name,
  Pst31Rate,
  Pst32Name,
  Pst32Rate,
  Pst33Name,
  Pst33Rate,
  Pst40ApDate,
  Pst40Name,
  Pst40Rate,
  PstAdd40,
  PstMethod40,
  Pst41Name,
  Pst41Rate,
  Pst42Name,
  Pst42Rate,
  Pst43Name,
  Pst43Rate,
  Wk14Gdd,
  Wk14Rain,
  WK15Gdd,
  WK15Rain,
  Wk16Gdd,
  WK16Rain,
  WK17Gdd,
  WK17Rain,
  WK18Gdd,
  WK18Rain,
  WK19Gdd,
  WK19Rain,
  WK20Gdd,
  WK20Rain,
  WK21Gdd,
  WK21Rain,
  WK22Gdd,
  WK22Rain,
  WK23Gdd,
  WK23Rain,
  WK24Gdd,
  WK24Rain,
  WK25Gdd,
  WK25Rain,
  WK26Gdd,
  WK26Rain,
  WK27Gdd,
  WK27Rain,
  WK28Gdd,
  WK28Rain,
  WK29Gdd,
  WK29Rain,
  WK30Gdd,
  WK30Rain,
  WK31Gdd,
  WK31Rain,
  WK32Gdd,
  WK32Rain,
  WK33Gdd,
  WK33Rain,
  WK34Gdd,
  WK34Rain,
  WK35Gdd,
  WK35Rain,
  WK36Gdd,
  WK36Rain,
  WK37Gdd,
  WK37Rain,
  WK38Gdd,
  WK38Rain,
  WK39Gdd,
  WK39Rain,
  TotGdd,
  TotRain
FROM gis..premierprocessedshapes pps WITH ( NOLOCK )
  JOIN gis..ProcessedLayer pl WITH ( NOLOCK )
    ON pl.UID = pps.ProcessedLayerUID
  JOIN gis..PCS_Weather w WITH ( NOLOCK )
    ON w.YearUID = pl.HierarchyItemUID
  JOIN PlatformManager..vHierarchyExpansion2 h WITH ( NOLOCK )
    ON h.YearUID = pl.HierarchyItemUID
  join PlatformManager..YearIDMapping ym with (NOLOCK)
    on ym.YearUID = pl.HierarchyItemUID
  JOIN QueryStruc.dbo.QT_GroupDetail gd on ym.YearUID = gd.YearUID
WHERE
  --   ym.Year = 2016
  gd.GroupID = 80158
  AND (Crop = 'Corn' OR Crop = 'Corn on Corn')
  AND Dry_Yield IS NOT NULL
  AND w.TotGdd IS NOT NULL AND w.TotRain IS NOT NULL
